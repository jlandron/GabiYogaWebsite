<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Gabi Yoga</title>
    <link rel="stylesheet" href="css/public-unified.css">
    <link rel="stylesheet" href="css/purchase-styles.css">
    <link rel="stylesheet" href="css/account-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Great+Vibes&family=Pacifico&family=Sacramento&family=Allura&family=Open+Sans&family=Playfair+Display&family=Roboto&family=Satisfy&family=Pinyon+Script&family=Tangerine&family=Alex+Brush&family=Amatic+SC&family=Caveat&family=Indie+Flower&family=Kalam&family=Shadows+Into+Light&family=Architects+Daughter&family=Comic+Neue&family=Courgette&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/fonts.css">
    <style>
        .form-error {
            color: #e74c3c;
            background-color: #fee;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            border-left: 3px solid #e74c3c;
        }
        
        .form-error i {
            margin-right: 5px;
        }
        
        #success-message {
            display: none;
            color: #2ecc71;
            background-color: #edfff2;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            border-left: 3px solid #2ecc71;
            text-align: center;
        }
        
        #success-message i {
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        #token-invalid-message {
            display: none;
            color: #e74c3c;
            background-color: #fee;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            border-left: 3px solid #e74c3c;
            text-align: center;
        }
        
        #token-invalid-message i {
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        #password-requirements {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        
        #password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .strength-weak {
            width: 33%;
            background-color: #e74c3c;
        }
        
        .strength-medium {
            width: 66%;
            background-color: #f39c12;
        }
        
        .strength-strong {
            width: 100%;
            background-color: #2ecc71;
        }
    </style>
</head>
<body>
    <!-- Header Component Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Reset Password Section -->
    <section class="account-section">
        <div class="container">
            <div class="account-container">
                <div class="account-card">
                    <div class="account-header">
                        <h2>Reset Your Password</h2>
                        <p>Please enter your new password</p>
                    </div>

                    <div id="token-invalid-message">
                        <i class="fas fa-exclamation-triangle"></i> This password reset link is invalid or has expired. Please request a new password reset.
                    </div>
                    
                    <div id="success-message">
                        <i class="fas fa-check-circle"></i> Your password has been reset successfully! You can now <a href="login.html">log in</a> with your new password.
                    </div>

                    <form id="reset-password-form" class="account-form">
                        <div class="form-group">
                            <label for="password">New Password</label>
                            <div class="password-container">
                                <input type="password" id="password" required minlength="8">
                                <i class="fas fa-eye-slash toggle-password"></i>
                            </div>
                            <div id="password-strength"></div>
                            <p id="password-requirements">Password must be at least 8 characters long.</p>
                        </div>

                        <div class="form-group">
                            <label for="confirm-password">Confirm New Password</label>
                            <div class="password-container">
                                <input type="password" id="confirm-password" required minlength="8">
                                <i class="fas fa-eye-slash toggle-password"></i>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-full-width">Reset Password</button>

                        <div class="form-separator">
                            <span>Remember your password?</span>
                        </div>

                        <a href="login.html" class="btn btn-secondary btn-full-width">Back to Login</a>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2>Gabi Yoga</h2>
                    <p>Find your inner peace with us</p>
                </div>
                <div class="footer-links">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="index.html#home">Home</a></li>
                        <li><a href="index.html#about">About</a></li>
                        <li><a href="index.html#offerings">Classes</a></li>
                        <li><a href="index.html#membership">Membership</a></li>
                        <li><a href="index.html#retreats">Retreats</a></li>
                        <li><a href="index.html#contact">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-newsletter">
                    <h3>Stay Updated</h3>
                    <p>Subscribe to our newsletter for updates on classes, workshops, and events</p>
                    <form class="newsletter-form">
                        <input type="email" placeholder="Your Email" required>
                        <button type="submit">Subscribe</button>
                    </form>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2025 Gabi Yoga. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/script.js"></script>
    <script src="js/header-loader.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle password visibility
            document.querySelectorAll('.toggle-password').forEach(icon => {
                icon.addEventListener('click', function() {
                    const passwordInput = this.previousElementSibling;
                    
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        this.classList.replace('fa-eye-slash', 'fa-eye');
                    } else {
                        passwordInput.type = 'password';
                        this.classList.replace('fa-eye', 'fa-eye-slash');
                    }
                });
            });
            
            // Check password strength
            const passwordInput = document.getElementById('password');
            const passwordStrength = document.getElementById('password-strength');
            
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                
                // Remove existing classes
                passwordStrength.classList.remove('strength-weak', 'strength-medium', 'strength-strong');
                
                if (password.length === 0) {
                    passwordStrength.style.display = 'none';
                    return;
                }
                
                passwordStrength.style.display = 'block';
                
                // Simple password strength check
                if (password.length < 8) {
                    passwordStrength.classList.add('strength-weak');
                } else if (password.length < 12 || 
                          !(/[A-Z]/.test(password) && /[a-z]/.test(password) && /[0-9]/.test(password))) {
                    passwordStrength.classList.add('strength-medium');
                } else {
                    passwordStrength.classList.add('strength-strong');
                }
            });
            
            // Get token and email from URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const email = urlParams.get('email');
            
            // Verify token and email are present
            if (!token || !email) {
                showTokenInvalidMessage();
                return;
            }
            
            // Verify token is valid with the API
            verifyToken(token, email);
            
            // Handle form submission
            const resetForm = document.getElementById('reset-password-form');
            resetForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Clear any existing error messages
                const existingErrors = document.querySelectorAll('.form-error');
                existingErrors.forEach(el => el.remove());
                
                // Get form values
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                // Validate passwords
                if (password.length < 8) {
                    showErrorMessage('Password must be at least 8 characters long.');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showErrorMessage('Passwords do not match.');
                    return;
                }
                
                // Show loading state
                const submitBtn = resetForm.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerText;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                
                try {
                    // Submit to API
                    const response = await fetch('/api/auth/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            token,
                            email,
                            password
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // Password reset successful
                        resetForm.style.display = 'none';
                        document.getElementById('success-message').style.display = 'block';
                    } else {
                        // Error resetting password
                        showErrorMessage(data.message || 'An error occurred while resetting your password.');
                        
                        // If token invalid, show that message
                        if (data.message && data.message.includes('Invalid or expired')) {
                            showTokenInvalidMessage();
                        }
                    }
                } catch (error) {
                    console.error('Error resetting password:', error);
                    showErrorMessage('An error occurred while resetting your password. Please try again.');
                } finally {
                    // Restore button state
                    submitBtn.disabled = false;
                    submitBtn.innerText = originalBtnText;
                }
            });
            
            // Helper function to show error message
            function showErrorMessage(message) {
                const errorEl = document.createElement('div');
                errorEl.className = 'form-error';
                errorEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                
                const submitBtn = resetForm.querySelector('button[type="submit"]');
                submitBtn.before(errorEl);
            }
            
            // Helper function to show token invalid message
            function showTokenInvalidMessage() {
                document.getElementById('reset-password-form').style.display = 'none';
                document.getElementById('token-invalid-message').style.display = 'block';
            }
            
            // Function to verify token with API
            async function verifyToken(token, email) {
                try {
                    const response = await fetch(`/api/auth/verify-reset-token?token=${encodeURIComponent(token)}&email=${encodeURIComponent(email)}`);
                    
                    const data = await response.json();
                    
                    if (!response.ok || !data.success) {
                        showTokenInvalidMessage();
                    }
                } catch (error) {
                    console.error('Error verifying token:', error);
                    // On error, we still allow the user to try to reset,
                    // the server will validate the token again on reset attempt
                }
            }
        });
    </script>
</body>
</html>
